# -----------------------
# Server Dockerfile.dev
# -----------------------
FROM node:24

WORKDIR /app

# Set max memory for Node processes to 8GB
ENV NODE_OPTIONS="--max-old-space-size=8192"

# Copy root config files
COPY ../../package.json ../../yarn.lock* ./
COPY ../../.yarn/releases ./ .yarn/releases
COPY ../../.yarnrc.yml ./

# Copy only server workspace + shared deps
COPY ../../packages/twenty-server ./packages/twenty-server
COPY ../../packages/twenty-shared ./packages/twenty-shared
COPY ../../packages/twenty-utils ./packages/twenty-utils
COPY ../../packages/twenty-ui ./packages/twenty-ui
COPY ../../packages/twenty-emails ./packages/twenty-emails

# Set yarn version
RUN corepack enable
RUN corepack prepare yarn@4.9.4 --activate

# Install only server workspace dependencies
RUN yarn cache clean
RUN yarn --cwd packages/twenty-server install

EXPOSE 3000

CMD ["yarn", "workspace", "twenty-server", "start:dev"]
